<!DOCTYPE html>

<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Produ√ß√£o de Soja</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

```
<style>
    :root {
        --green: #34C759;
        --green-dark: #1B4332;
        --green-light: #E8F5E9;
        --bg: #F2F2F7;
        --card: #FFF;
        --text: #1D1D1F;
        --text2: #8E8E93;
        --text3: #C7C7CC;
        --font: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
        --photo-size: 80px;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: var(--font); background: var(--bg); color: var(--text); font-size: 14px; }
    
    .header {
        background: linear-gradient(180deg, var(--green-dark), #14332B);
        padding: 10px 16px;
        text-align: center;
    }
    .header h1 { color: #FFF; font-size: 0.9rem; font-weight: 600; }
    
    .container { max-width: 420px; margin: 0 auto; padding: 6px 8px 70px; }
    
    .pdf-content { background: #FFF; }
    
    .card {
        background: var(--card);
        border-radius: 10px;
        margin-bottom: 6px;
        overflow: hidden;
        page-break-inside: avoid;
        break-inside: avoid;
    }
    
    .card-head {
        padding: 6px 10px 3px;
        font-size: 0.55rem;
        font-weight: 600;
        color: var(--text2);
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    
    .card-body { padding: 4px 10px 8px; }
    
    .aviso {
        background: #FFFBEB;
        border-left: 3px solid #F59E0B;
        border-radius: 0 8px 8px 0;
        padding: 6px 10px;
        margin-bottom: 6px;
        page-break-inside: avoid;
        break-inside: avoid;
    }
    .aviso-title { font-size: 0.6rem; font-weight: 600; color: #B45309; }
    .aviso-text { font-size: 0.5rem; color: #92400E; line-height: 1.3; margin-top: 2px; }
    
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 4px; }
    .grid-2:last-child { margin-bottom: 0; }
    
    .field { min-width: 0; }
    
    label {
        display: block;
        font-size: 0.5rem;
        color: var(--text2);
        margin-bottom: 2px;
        text-transform: uppercase;
        letter-spacing: 0.2px;
    }
    
    input, textarea {
        width: 100%;
        height: 28px;
        background: var(--bg);
        border: none;
        border-radius: 6px;
        padding: 0 8px;
        font-size: 0.75rem;
        font-family: var(--font);
        color: var(--text);
    }
    
    textarea {
        height: 40px;
        padding: 8px;
        resize: none;
        line-height: 1.3;
    }
    
    input:focus, textarea:focus { outline: 2px solid var(--green); outline-offset: -2px; }
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; }
    input[type=number] { -moz-appearance: textfield; }
    
    .unit { position: relative; }
    .unit span {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.5rem;
        color: var(--text3);
    }
    .unit input { padding-right: 20px; }
    
    .calc-field input {
        background: var(--green-light);
        color: var(--green-dark);
        font-weight: 600;
    }
    
    .result-field input {
        background: var(--green-light);
        color: var(--green-dark);
        font-weight: 600;
        text-align: right;
    }
    
    .section-photo {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        border: none;
    }
    
    .photo-col {
        flex-shrink: 0;
        width: var(--photo-size);
    }
    
    .photo-box {
        width: var(--photo-size);
        height: var(--photo-size);
        border-radius: 8px;
        overflow: hidden;
        background: var(--bg);
        position: relative;
        border: none;
    }
    .photo-box img { 
        width: 100%; 
        height: 100%; 
        object-fit: cover;
    }
    .photo-box .del {
        position: absolute;
        top: 3px;
        right: 3px;
        width: 18px;
        height: 18px;
        background: rgba(0,0,0,0.6);
        border: none;
        border-radius: 50%;
        color: #FFF;
        font-size: 11px;
        cursor: pointer;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .photo-placeholder {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: transparent;
        border: 1.5px solid #D1D1D6;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    .photo-placeholder:hover {
        border-color: var(--green);
        background: var(--green-light);
    }
    .photo-placeholder span {
        font-size: 14px;
        color: #C7C7CC;
        font-weight: 300;
        line-height: 1;
    }
    .photo-placeholder:hover span {
        color: var(--green);
    }
    
    .fields-wrap {
        flex: 1;
        min-width: 0;
    }
    
    .result {
        background: linear-gradient(180deg, var(--green-dark), #14332B);
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 6px;
        page-break-inside: avoid;
        break-inside: avoid;
    }
    
    .result-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
    }
    
    .result-item {
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        padding: 8px 4px;
        text-align: center;
    }
    
    .result-main {
        grid-column: 1 / -1;
        background: var(--green);
        margin-top: 6px;
        padding: 12px;
    }
    
    .result-item small {
        display: block;
        font-size: 0.45rem;
        color: rgba(255,255,255,0.6);
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    .result-item .val { 
        font-size: 0.9rem; 
        font-weight: 700; 
        color: #FFF;
        margin-top: 2px;
    }
    .result-main .val { font-size: 1.3rem; }
    .result-item .un { font-size: 0.4rem; color: rgba(255,255,255,0.5); }
    
    .toggle {
        background: none;
        border: none;
        color: rgba(255,255,255,0.5);
        font-size: 0.45rem;
        cursor: pointer;
        margin-top: 6px;
        padding: 4px 8px;
    }
    
    .details {
        display: none;
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px solid rgba(255,255,255,0.15);
        font-size: 0.45rem;
    }
    .details.show { display: block; }
    .details div { 
        display: flex; 
        justify-content: space-between; 
        padding: 2px 0; 
        color: rgba(255,255,255,0.5); 
    }
    .details span:last-child { color: rgba(255,255,255,0.85); font-weight: 500; }
    
    .photo-gallery {
        background: var(--card);
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 6px;
        page-break-inside: avoid;
        break-inside: avoid;
    }
    
    .photo-gallery-head {
        font-size: 0.55rem;
        font-weight: 600;
        color: var(--text2);
        text-transform: uppercase;
        letter-spacing: 0.3px;
        margin-bottom: 8px;
    }
    
    .photo-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .photo-item {
        width: 100%;
        aspect-ratio: 4/3;
        border-radius: 10px;
        overflow: hidden;
        background: var(--bg);
        position: relative;
        page-break-inside: avoid;
        break-inside: avoid;
    }
    
    .photo-item img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        background: var(--bg);
    }
    
    .photo-note {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(10px);
        border: none;
        padding: 6px 8px;
        font-size: 0.5rem;
        font-family: var(--font);
        color: var(--text);
        resize: none;
        outline: none;
    }
    
    .photo-note::placeholder {
        color: var(--text3);
    }
    
    .photo-note:focus {
        background: rgba(255, 255, 255, 0.95);
    }
    
    .photo-item .del-photo {
        position: absolute;
        top: 6px;
        right: 6px;
        width: 20px;
        height: 20px;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(8px);
        border: none;
        border-radius: 50%;
        color: #FFF;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    
    .photo-item .del-photo:hover {
        background: #FF3B30;
        transform: scale(1.1);
    }
    
    .photo-add {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 1.5px dashed #D1D1D6;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
        page-break-inside: avoid;
        break-inside: avoid;
    }
    
    .photo-add:hover {
        border-color: var(--green);
        background: var(--green-light);
        transform: scale(1.05);
    }
    
    .photo-add-icon {
        font-size: 18px;
        color: var(--text3);
        line-height: 1;
        transition: all 0.2s;
    }
    
    .photo-add:hover .photo-add-icon {
        color: var(--green);
    }
    
    .footer {
        display: flex;
        align-items: center;
        gap: 8px;
        background: var(--card);
        border-radius: 10px;
        padding: 8px 10px;
        margin-bottom: 6px;
        page-break-inside: avoid;
        break-inside: avoid;
    }
    
    .footer-logo {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: var(--bg);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        overflow: hidden;
        font-size: 0.4rem;
        color: var(--text3);
    }
    .footer-logo img { width: 100%; height: 100%; object-fit: contain; }
    .footer-info { flex: 1; }
    .footer-info input { height: 22px; font-size: 0.65rem; margin-bottom: 3px; }
    .footer-info input:last-child { margin-bottom: 0; }
    
    .branding {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
        padding: 8px;
        font-size: 0.5rem;
    }
    .branding-link {
        background: var(--card);
        border-radius: 8px;
        padding: 6px 8px;
        text-align: center;
        text-decoration: none;
        color: var(--text);
        transition: all 0.2s;
        border: 1px solid #E5E5EA;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 50px;
    }
    .branding-link:hover {
        border-color: var(--green);
        background: var(--green-light);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(52, 199, 89, 0.2);
    }
    .brand-solo { color: var(--text); font-weight: 600; }
    .brand-forte { color: var(--green); font-weight: 600; }
    .branding-link .icon {
        font-size: 1.2rem;
        margin-bottom: 2px;
    }
    .branding-link .title {
        font-weight: 600;
        font-size: 0.55rem;
        color: var(--text);
    }
    .branding-link small {
        display: block;
        font-size: 0.4rem;
        color: var(--text3);
        margin-top: 1px;
    }
    
    .fabs {
        position: fixed;
        bottom: 12px;
        right: 10px;
        display: flex;
        gap: 8px;
    }
    .fab {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        transition: transform 0.2s;
    }
    .fab:active { transform: scale(0.95); }
    .fab-w { background: #FFF; }
    .fab-w svg { width: 18px; height: 18px; fill: var(--text2); }
    .fab-g { background: var(--green); }
    .fab-g svg { width: 18px; height: 18px; fill: #FFF; }
    
    .loading {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        align-items: center;
        justify-content: center;
        z-index: 999;
    }
    .loading.show { display: flex; }
    .loading-box {
        background: #FFF;
        padding: 24px 32px;
        border-radius: 14px;
        text-align: center;
    }
    .loading-box p { font-size: 0.8rem; color: var(--text); margin-top: 10px; }
    .spinner {
        width: 32px;
        height: 32px;
        border: 3px solid var(--bg);
        border-top-color: var(--green);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Estilos PDF - Imagens maiores, melhor qualidade */
    .pdf-mode {
        --photo-size: 100px;
    }
    .pdf-mode .container {
        max-width: 100%;
        padding: 0;
        background: #FFF;
    }
    .pdf-mode .pdf-content {
        padding: 12px;
    }
    .pdf-mode .card {
        border-radius: 12px;
        margin-bottom: 10px;
        page-break-inside: avoid;
    }
    .pdf-mode .card-head {
        padding: 8px 12px 4px;
        font-size: 0.6rem;
    }
    .pdf-mode .card-body {
        padding: 6px 12px 10px;
    }
    .pdf-mode .aviso {
        border-radius: 0 10px 10px 0;
        margin-bottom: 10px;
        padding: 10px 12px;
        page-break-inside: avoid;
    }
    .pdf-mode .aviso-title {
        font-size: 0.65rem;
    }
    .pdf-mode .aviso-text {
        font-size: 0.55rem;
    }
    .pdf-mode .result {
        border-radius: 12px;
        margin-bottom: 10px;
        padding: 12px;
        page-break-inside: avoid;
    }
    .pdf-mode .footer {
        border-radius: 12px;
        margin-bottom: 10px;
        padding: 10px 12px;
        page-break-inside: avoid;
    }
    .pdf-mode .footer-logo {
        width: 50px;
        height: 50px;
    }
    .pdf-mode .photo-gallery {
        border-radius: 12px;
        margin-bottom: 10px;
        padding: 12px;
        page-break-inside: avoid;
    }
    
    .pdf-mode .photo-gallery-head {
        font-size: 0.6rem;
        margin-bottom: 10px;
    }
    
    .pdf-mode .photo-list {
        gap: 10px;
    }
    
    .pdf-mode .photo-item {
        border-radius: 12px;
    }
    
    .pdf-mode .photo-note {
        font-size: 0.55rem;
        padding: 8px 10px;
        background: rgba(255, 255, 255, 0.95);
    }
    
    .pdf-mode .photo-add {
        width: 40px;
        height: 40px;
    }
    
    .pdf-mode .photo-add-icon {
        font-size: 20px;
    }
    
    .pdf-mode .branding {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        padding: 12px;
        background: transparent;
        page-break-inside: avoid;
    }
    .pdf-mode .branding-link {
        background: var(--green-dark);
        color: #FFF;
        border: 2px solid rgba(255,255,255,0.1);
        padding: 10px;
        min-height: 60px;
    }
    .pdf-mode .branding-link .icon {
        font-size: 1.4rem;
        margin-bottom: 3px;
    }
    .pdf-mode .branding-link .title {
        color: #FFF;
        font-size: 0.6rem;
    }
    .pdf-mode .brand-solo {
        color: #FFF;
    }
    .pdf-mode .brand-forte {
        color: var(--green);
    }
    .pdf-mode .branding-link small {
        color: rgba(255,255,255,0.6);
        font-size: 0.45rem;
    }
    .pdf-mode .grid-2 {
        gap: 8px;
        margin-bottom: 6px;
    }
    .pdf-mode input, .pdf-mode textarea {
        height: 32px;
        font-size: 0.8rem;
        padding: 0 10px;
    }
    .pdf-mode textarea {
        height: 50px;
        padding: 10px;
    }
    .pdf-mode label {
        font-size: 0.58rem;
        margin-bottom: 3px;
    }
    .pdf-mode .section-photo {
        gap: 12px;
    }
    .pdf-mode .photo-col {
        width: 100px;
    }
    .pdf-mode .photo-box {
        width: 100px;
        height: 100px;
        border-radius: 10px;
    }
    .pdf-mode .result-item .val {
        font-size: 1rem;
    }
    .pdf-mode .result-main .val {
        font-size: 1.5rem;
    }
    
    @media print {
        .fabs, .header { display: none !important; }
        .details { display: block !important; }
    }
</style>
```

</head>
<body>
    <header class="header">
        <h1>Estimativa de Produ√ß√£o ‚Äî Soja</h1>
    </header>

```
<div class="container">
    <main class="pdf-content" id="content">
        <div class="aviso">
            <div class="aviso-title">üìå Expectativa de Produ√ß√£o (Estimativa T√©cnica)</div>
            <div class="aviso-text">üì¢ Os n√∫meros s√£o proje√ß√µes t√©cnicas e n√£o garantem resultados absolutos, sujeitos a varia√ß√µes clim√°ticas, de manejo e campo.</div>
        </div>
        
        <section class="card">
            <div class="card-head">Identifica√ß√£o</div>
            <div class="card-body">
                <div class="grid-2">
                    <div class="field"><label>Produtor</label><input type="text" id="produtor" placeholder="‚Äî"></div>
                    <div class="field"><label>Fazenda</label><input type="text" id="fazenda" placeholder="‚Äî"></div>
                </div>
                <div class="grid-2">
                    <div class="field"><label>Cidade/UF</label><input type="text" id="cidade" placeholder="‚Äî"></div>
                    <div class="field"><label>Cultivar</label><input type="text" id="cultivar" placeholder="‚Äî"></div>
                </div>
                <div class="grid-2">
                    <div class="field unit"><label>√Årea</label><input type="number" id="area" placeholder="‚Äî" step="0.1"><span>ha</span></div>
                    <div class="field"><label>Data</label><input type="date" id="data"></div>
                </div>
            </div>
        </section>
        
        <section class="card">
            <div class="card-head">Popula√ß√£o</div>
            <div class="card-body">
                <div class="grid-2">
                    <div class="field"><label>Plantas/Metro</label><input type="number" id="plantasMetro" placeholder="‚Äî" step="0.1"></div>
                    <div class="field unit"><label>Espa√ßamento</label><input type="number" id="espacamento" value="0.5" step="0.05"><span>m</span></div>
                </div>
                <div class="grid-2">
                    <div class="field calc-field"><label>Plantas/ha</label><input type="text" id="plantasHa" readonly></div>
                    <div class="field"></div>
                </div>
            </div>
        </section>
        
        <section class="card">
            <div class="card-head">Componentes de Rendimento</div>
            <div class="card-body">
                <div class="grid-2">
                    <div class="field"><label>Plantas Aval.</label><input type="number" id="plantasAval" value="3" min="1"></div>
                    <div class="field"><label>Vagens/Planta</label><input type="number" id="vagens" placeholder="‚Äî" step="0.1"></div>
                </div>
                <div class="grid-2">
                    <div class="field"><label>Gr√£os/Vagem</label><input type="number" id="graos" placeholder="‚Äî" step="0.1"></div>
                    <div class="field result-field"><label>Gr√£os/Planta</label><input type="text" id="rGraosPl" readonly></div>
                </div>
                <div class="grid-2" style="margin-top: 4px;">
                    <div class="field unit"><label>PMG</label><input type="number" id="pmg" placeholder="‚Äî" step="0.1"><span>g</span></div>
                    <div class="field result-field"><label>g/Planta</label><input type="text" id="rGramasPl" readonly></div>
                </div>
                <div class="grid-2" style="margin-top: 4px;">
                    <div class="field"><label>Entren√≥s/Planta</label><input type="number" id="entrenos" placeholder="‚Äî"></div>
                    <div class="field unit"><label>Perdas</label><input type="number" id="perdas" value="20"><span>%</span></div>
                </div>
            </div>
        </section>
        
        <section class="card">
            <div class="card-head">Observa√ß√µes</div>
            <div class="card-body">
                <textarea id="anotacaoGeral" placeholder="Anota√ß√µes gerais sobre a avalia√ß√£o..."></textarea>
            </div>
        </section>
        
        <section class="result">
            <div class="result-grid">
                <div class="result-item"><small>kg/ha</small><div class="val" id="rKg">‚Äî</div></div>
                <div class="result-item"><small>Bruto</small><div class="val" id="rBruto">‚Äî</div><div class="un">sc/ha</div></div>
                <div class="result-item"><small>L√≠quido</small><div class="val" id="rLiqItem">‚Äî</div><div class="un">sc/ha</div></div>
                <div class="result-item result-main"><small>Produ√ß√£o Estimada</small><div class="val" id="rLiquido">‚Äî</div><div class="un">sacas/ha</div></div>
            </div>
            <button class="toggle" onclick="toggleDetails()">‚ñº Detalhes do c√°lculo</button>
            <div class="details" id="details">
                <div><span>Gr√£os/planta</span><span id="d1">‚Äî</span></div>
                <div><span>Gramas/planta</span><span id="d2">‚Äî</span></div>
                <div><span>kg/ha</span><span id="d3">‚Äî</span></div>
                <div><span>Sacas bruto</span><span id="d4">‚Äî</span></div>
                <div><span>Sacas l√≠quido</span><span id="d5">‚Äî</span></div>
            </div>
        </section>
        
        <section class="photo-gallery">
            <div class="photo-gallery-head">Fotos da Avalia√ß√£o</div>
            <div class="photo-list" id="photoList"></div>
        </section>
        
        <section class="footer">
            <div class="footer-logo" onclick="document.getElementById('logoInput').click()" id="logoBox">Logo</div>
            <div class="footer-info">
                <input type="text" id="editorNome" placeholder="Respons√°vel t√©cnico">
                <input type="text" id="editorContato" placeholder="Contato / CREA">
            </div>
        </section>
        
        <div class="branding">
            <a href="https://afonsoraudinei.github.io/Calculadorasoja/" target="_blank" class="branding-link">
                <div class="icon">üå±</div>
                <div class="title"><span class="brand-solo">Solo</span><span class="brand-forte">Forte</span></div>
                <small>Nova estimativa</small>
            </a>
            <a href="https://afonsoraudinei.github.io/Relat-rio-/" target="_blank" class="branding-link">
                <div class="icon">üìã</div>
                <div class="title">Avalia√ß√£o</div>
                <small>Relat√≥rio completo</small>
            </a>
            <a href="https://afonsoraudinei.github.io/ocorrencia/" target="_blank" class="branding-link">
                <div class="icon">‚ö†Ô∏è</div>
                <div class="title">Ocorr√™ncia</div>
                <small>Registrar problema</small>
            </a>
            <a href="https://afonsoraudinei.github.io/Planejamento/" target="_blank" class="branding-link">
                <div class="icon">üìÖ</div>
                <div class="title">Planejamento</div>
                <small>Agenda semanal</small>
            </a>
        </div>
    </main>
</div>

<div class="fabs" id="fabs">
    <button class="fab fab-w" onclick="limpar()" title="Limpar"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
    <button class="fab fab-g" onclick="exportPDF()" title="Exportar PDF"><svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></button>
</div>

<div class="loading" id="loading">
    <div class="loading-box">
        <div class="spinner"></div>
        <p>Gerando PDF...</p>
    </div>
</div>

<input type="file" id="fileInput" accept="image/*" hidden>
<input type="file" id="logoInput" accept="image/*" hidden>

<script>
    let photos = JSON.parse(localStorage.getItem('soja_photos_gallery')) || [];
    let logo = localStorage.getItem('soja_logo') || null;
    
    const fields = ['produtor','fazenda','cidade','cultivar','area','data','plantasMetro','espacamento','plantasAval','vagens','graos','pmg','entrenos','perdas','editorNome','editorContato','anotacaoGeral'];
    
    // Migrar dados antigos se necess√°rio
    if (photos.length > 0 && typeof photos[0] === 'string') {
        photos = photos.map(img => ({ image: img, note: '' }));
        localStorage.setItem('soja_photos_gallery', JSON.stringify(photos));
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        renderGallery();
        renderLogo();
        calc();
        if (!document.getElementById('data').value) {
            document.getElementById('data').valueAsDate = new Date();
        }
    });
    
    function renderGallery() {
        const list = document.getElementById('photoList');
        if (!list) return;
        
        list.innerHTML = '';
        
        // Mostrar fotos existentes (cada uma em linha cheia)
        photos.forEach((photo, index) => {
            const item = document.createElement('div');
            item.className = 'photo-item';
            item.innerHTML = `
                <img src="${photo.image}">
                <textarea class="photo-note" placeholder="Anota√ß√£o..." oninput="updateNote(${index}, this.value)">${photo.note || ''}</textarea>
                <button class="del-photo" onclick="deletePhoto(${index})">√ó</button>
            `;
            list.appendChild(item);
        });
        
        // Mostrar bot√£o min√∫sculo de adicionar se tiver menos de 4 fotos
        if (photos.length < 4) {
            const addBtn = document.createElement('div');
            addBtn.className = 'photo-add';
            addBtn.onclick = () => document.getElementById('fileInput').click();
            addBtn.innerHTML = `<div class="photo-add-icon">+</div>`;
            list.appendChild(addBtn);
        }
    }
    
    function updateNote(index, value) {
        photos[index].note = value;
        localStorage.setItem('soja_photos_gallery', JSON.stringify(photos));
    }
    
    function loadData() {
        const d = JSON.parse(localStorage.getItem('soja_data')) || {};
        fields.forEach(id => { 
            const el = document.getElementById(id); 
            if (el && d[id]) el.value = d[id]; 
        });
    }
    
    function saveData() {
        const d = {};
        fields.forEach(id => { 
            const el = document.getElementById(id); 
            if (el) d[id] = el.value; 
        });
        localStorage.setItem('soja_data', JSON.stringify(d));
    }
    
    function calcPlantasHa() {
        const pm = parseFloat(document.getElementById('plantasMetro').value) || 0;
        const esp = parseFloat(document.getElementById('espacamento').value) || 0.5;
        if (pm && esp) {
            const pl = Math.round(pm * (10000 / esp));
            document.getElementById('plantasHa').value = pl.toLocaleString('pt-BR');
            return pl;
        }
        document.getElementById('plantasHa').value = '';
        return 0;
    }
    
    function calc() {
        const plantasHa = calcPlantasHa();
        const v = parseFloat(document.getElementById('vagens').value) || 0;
        const g = parseFloat(document.getElementById('graos').value) || 0;
        const pmg = parseFloat(document.getElementById('pmg').value) || 0;
        const p = parseFloat(document.getElementById('perdas').value) || 0;
        
        const graosPl = v * g;
        document.getElementById('rGraosPl').value = graosPl ? graosPl.toFixed(1) : '';
        
        const gramasPl = graosPl * (pmg / 1000);
        document.getElementById('rGramasPl').value = gramasPl ? gramasPl.toFixed(2) : '';
        
        if (!plantasHa || !v || !g || !pmg) {
            ['rKg','rBruto','rLiqItem','rLiquido'].forEach(id => document.getElementById(id).textContent = '‚Äî');
            ['d1','d2','d3','d4','d5'].forEach(id => document.getElementById(id).textContent = '‚Äî');
            return;
        }
        
        const kgHa = (plantasHa * gramasPl) / 1000;
        const scB = kgHa / 60;
        const scL = scB * (1 - p / 100);
        
        document.getElementById('rKg').textContent = kgHa.toFixed(0);
        document.getElementById('rBruto').textContent = scB.toFixed(1);
        document.getElementById('rLiqItem').textContent = scL.toFixed(1);
        document.getElementById('rLiquido').textContent = scL.toFixed(2);
        
        document.getElementById('d1').textContent = `${v} √ó ${g} = ${graosPl.toFixed(1)}`;
        document.getElementById('d2').textContent = `${graosPl.toFixed(1)} √ó ${(pmg/1000).toFixed(3)} = ${gramasPl.toFixed(2)}g`;
        document.getElementById('d3').textContent = `${gramasPl.toFixed(2)} √ó ${plantasHa.toLocaleString()} = ${kgHa.toFixed(0)}`;
        document.getElementById('d4').textContent = `${kgHa.toFixed(0)} √∑ 60 = ${scB.toFixed(2)} sc`;
        document.getElementById('d5').textContent = `${scB.toFixed(2)} √ó ${((100-p)/100).toFixed(2)} = ${scL.toFixed(2)} sc`;
        
        saveData();
    }
    
    function toggleDetails() {
        document.getElementById('details').classList.toggle('show');
    }
    
    fields.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', () => { calc(); saveData(); });
    });
    
    function deletePhoto(index) {
        photos.splice(index, 1);
        localStorage.setItem('soja_photos_gallery', JSON.stringify(photos));
        renderGallery();
    }
    
    document.getElementById('fileInput').addEventListener('change', async e => {
        const f = e.target.files[0];
        if (!f) return;
        
        if (photos.length >= 4) {
            alert('M√°ximo de 4 fotos atingido');
            e.target.value = '';
            return;
        }
        
        try {
            // Compress√£o para boa qualidade
            const compressed = await compressImage(f, 1200, 0.90);
            photos.push({ image: compressed, note: '' });
            localStorage.setItem('soja_photos_gallery', JSON.stringify(photos));
            renderGallery();
        } catch (err) {
            console.error('Erro ao processar imagem:', err);
        }
        
        e.target.value = '';
    });
    
    function renderLogo() {
        const box = document.getElementById('logoBox');
        box.innerHTML = logo ? `<img src="${logo}">` : 'Logo';
    }
    
    document.getElementById('logoInput').addEventListener('change', async e => {
        const f = e.target.files[0];
        if (!f) return;
        
        try {
            logo = await compressImage(f, 200, 0.85);
            localStorage.setItem('soja_logo', logo);
            renderLogo();
        } catch (err) {
            console.error('Erro ao processar logo:', err);
        }
        
        e.target.value = '';
    });
    
    function compressImage(file, maxSize, quality) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width;
                    let h = img.height;
                    
                    if (w > h) {
                        if (w > maxSize) {
                            h = Math.round(h * maxSize / w);
                            w = maxSize;
                        }
                    } else {
                        if (h > maxSize) {
                            w = Math.round(w * maxSize / h);
                            h = maxSize;
                        }
                    }
                    
                    canvas.width = w;
                    canvas.height = h;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, w, h);
                    
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = reject;
                img.src = e.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }
    
    function limpar() {
        if (confirm('Limpar todos os dados?')) {
            localStorage.removeItem('soja_data');
            localStorage.removeItem('soja_photos_gallery');
            localStorage.removeItem('soja_logo');
            location.reload();
        }
    }
    
    async function exportPDF() {
        const loading = document.getElementById('loading');
        const fabs = document.getElementById('fabs');
        const details = document.getElementById('details');
        const content = document.getElementById('content');
        
        loading.classList.add('show');
        fabs.style.display = 'none';
        details.classList.add('show');
        
        // Ativar modo PDF
        document.body.classList.add('pdf-mode');
        
        // Esconder bot√µes de deletar e adicionar foto
        document.querySelectorAll('.del-photo, .photo-add').forEach(el => {
            el.style.display = 'none';
        });
        
        try {
            await new Promise(r => setTimeout(r, 300));
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 6; // Margem menor
            const contentWidth = pageWidth - (margin * 2);
            const maxHeight = pageHeight - (margin * 2);
            
            let currentY = margin;
            let pageNumber = 1;
            
            // Fun√ß√£o para adicionar elemento ao PDF
            async function addElementToPDF(element, isPhoto = false) {
                const canvas = await html2canvas(element, {
                    scale: 2.5,
                    useCORS: true,
                    backgroundColor: '#FFFFFF',
                    logging: false,
                    imageTimeout: 0,
                    allowTaint: true
                });
                
                const imgData = canvas.toDataURL('image/jpeg', 0.92);
                const imgWidth = contentWidth;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // Gap menor entre elementos (2mm normal, 1mm para fotos)
                const gap = isPhoto ? 1 : 2;
                
                // Se n√£o couber na p√°gina atual, criar nova
                if (currentY + imgHeight > maxHeight) {
                    pdf.addPage();
                    currentY = margin;
                    pageNumber++;
                }
                
                pdf.addImage(imgData, 'JPEG', margin, currentY, imgWidth, imgHeight);
                currentY += imgHeight + gap;
            }
            
            // Capturar cada se√ß√£o separadamente
            const aviso = content.querySelector('.aviso');
            if (aviso) await addElementToPDF(aviso);
            
            const cards = content.querySelectorAll('.card');
            for (const card of cards) {
                await addElementToPDF(card);
            }
            
            const result = content.querySelector('.result');
            if (result) await addElementToPDF(result);
            
            // Fotos individuais com gap menor
            const photoItems = content.querySelectorAll('.photo-item');
            if (photoItems.length > 0) {
                // Adicionar header da galeria se houver fotos
                const galleryHead = content.querySelector('.photo-gallery-head');
                if (galleryHead) {
                    const headCanvas = await html2canvas(galleryHead, {
                        scale: 2.5,
                        useCORS: true,
                        backgroundColor: '#FFFFFF',
                        logging: false
                    });
                    const headData = headCanvas.toDataURL('image/jpeg', 0.92);
                    const headWidth = contentWidth;
                    const headHeight = (headCanvas.height * headWidth) / headCanvas.width;
                    
                    if (currentY + headHeight > maxHeight) {
                        pdf.addPage();
                        currentY = margin;
                        pageNumber++;
                    }
                    
                    pdf.addImage(headData, 'JPEG', margin, currentY, headWidth, headHeight);
                    currentY += headHeight + 2;
                }
                
                for (const photo of photoItems) {
                    await addElementToPDF(photo, true);
                }
            }
            
            const footer = content.querySelector('.footer');
            if (footer) await addElementToPDF(footer);
            
            const branding = content.querySelector('.branding');
            if (branding) await addElementToPDF(branding);
            
            // Adicionar links clic√°veis na √∫ltima p√°gina
            const totalPages = pdf.internal.getNumberOfPages();
            pdf.setPage(totalPages);
            
            // Posi√ß√£o dos links baseada no branding
            const linkHeight = 12;
            const linkWidth = (contentWidth - 4) / 2;
            const brandingBottom = currentY - 2; // Posi√ß√£o aproximada do branding
            
            const links = [
                { url: 'https://afonsoraudinei.github.io/Calculadorasoja/', x: margin, y: brandingBottom },
                { url: 'https://afonsoraudinei.github.io/Relat-rio-/', x: pageWidth/2 + 1, y: brandingBottom },
                { url: 'https://afonsoraudinei.github.io/ocorrencia/', x: margin, y: brandingBottom + linkHeight + 2 },
                { url: 'https://afonsoraudinei.github.io/Planejamento/', x: pageWidth/2 + 1, y: brandingBottom + linkHeight + 2 }
            ];
            
            links.forEach(link => {
                pdf.link(link.x, link.y, linkWidth - 2, linkHeight, { url: link.url });
            });
            
            const fileName = `estimativa-soja-${new Date().toISOString().slice(0,10)}.pdf`;
            pdf.save(fileName);
            
        } catch (err) {
            console.error('Erro ao gerar PDF:', err);
            alert('Erro ao gerar PDF. Tente novamente.');
        } finally {
            document.body.classList.remove('pdf-mode');
            
            document.querySelectorAll('.del-photo, .photo-add').forEach(el => {
                el.style.display = '';
            });
            fabs.style.display = 'flex';
            loading.classList.remove('show');
            details.classList.remove('show');
        }
    }
</script>
```

</body>
</html>
