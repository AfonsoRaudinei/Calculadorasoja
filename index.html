<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Produ√ß√£o de Soja</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root {
            --green: #34C759;
            --green-dark: #1B4332;
            --green-light: #E8F5E9;
            --bg: #F2F2F7;
            --card: #FFF;
            --text: #1D1D1F;
            --text2: #8E8E93;
            --text3: #C7C7CC;
            --border: #E5E5EA;
            --font: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font); background: var(--bg); color: var(--text); font-size: 14px; }
        
        .header {
            background: linear-gradient(180deg, var(--green-dark), #14332B);
            padding: 10px 16px;
            text-align: center;
        }
        .header h1 { color: #FFF; font-size: 0.85rem; font-weight: 600; }
        
        .container { max-width: 380px; margin: 0 auto; padding: 6px 8px 70px; }
        
        .card {
            background: var(--card);
            border-radius: 10px;
            margin-bottom: 6px;
        }
        
        .card-head {
            padding: 6px 10px 4px;
            font-size: 0.55rem;
            font-weight: 600;
            color: var(--text2);
            text-transform: uppercase;
        }
        
        .card-body { padding: 4px 10px 8px; }
        
        /* Aviso */
        .aviso {
            background: #FFFBEB;
            border-left: 3px solid #F59E0B;
            border-radius: 0 8px 8px 0;
            padding: 6px 8px;
            margin-bottom: 6px;
        }
        .aviso-title { font-size: 0.65rem; font-weight: 600; color: #B45309; }
        .aviso-text { font-size: 0.5rem; color: #92400E; line-height: 1.3; margin-top: 2px; }
        
        /* Fields */
        .row { display: flex; gap: 6px; margin-bottom: 4px; }
        .row:last-child { margin-bottom: 0; }
        .col { flex: 1; min-width: 0; }
        
        label {
            display: block;
            font-size: 0.5rem;
            color: var(--text2);
            margin-bottom: 1px;
            text-transform: uppercase;
        }
        
        input, textarea {
            width: 100%;
            height: 28px;
            background: var(--bg);
            border: none;
            border-radius: 6px;
            padding: 0 6px;
            font-size: 0.75rem;
            font-family: var(--font);
            color: var(--text);
        }
        
        textarea {
            height: 44px;
            padding: 6px;
            resize: none;
            line-height: 1.3;
        }
        
        input:focus, textarea:focus { outline: 2px solid var(--green); outline-offset: -2px; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; }
        input[type=number] { -moz-appearance: textfield; }
        
        .unit { position: relative; }
        .unit span {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.5rem;
            color: var(--text3);
        }
        .unit input { padding-right: 16px; }
        
        .calc-field input {
            background: var(--green-light);
            color: var(--green-dark);
            font-weight: 600;
        }
        
        .result-field input {
            background: var(--green-light);
            color: var(--green-dark);
            font-weight: 600;
            text-align: right;
        }
        
        /* Metric com foto */
        .metric {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
        }
        .metric:last-child { margin-bottom: 0; }
        
        .photo-col {
            width: 70px;
            flex-shrink: 0;
        }
        .photo-col.empty { width: 22px; }
        
        .photo-box {
            width: 70px;
            height: 70px;
            border-radius: 6px;
            overflow: hidden;
            background: var(--bg);
            position: relative;
        }
        .photo-box img { width: 100%; height: 100%; object-fit: cover; }
        .photo-box .del {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            background: rgba(0,0,0,0.5);
            border: none;
            border-radius: 50%;
            color: #FFF;
            font-size: 10px;
            cursor: pointer;
        }
        
        .photo-note {
            margin-top: 3px;
        }
        .photo-note input {
            height: 20px;
            font-size: 0.55rem;
            padding: 0 4px;
        }
        
        .add-btn {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--bg);
            border: none;
            color: var(--text3);
            font-size: 12px;
            cursor: pointer;
        }
        .add-btn:hover { background: var(--green-light); color: var(--green); }
        
        .fields-col { flex: 1; display: flex; flex-direction: column; gap: 3px; }
        
        /* Resultado */
        .result {
            background: linear-gradient(180deg, var(--green-dark), #14332B);
            border-radius: 10px;
            padding: 8px;
            margin-bottom: 6px;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
        }
        
        .result-item {
            background: rgba(255,255,255,0.08);
            border-radius: 6px;
            padding: 6px 4px;
            text-align: center;
        }
        
        .result-main {
            grid-column: 1 / -1;
            background: var(--green);
            margin-top: 4px;
        }
        
        .result-item small {
            display: block;
            font-size: 0.45rem;
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
        }
        .result-item .val { font-size: 0.8rem; font-weight: 700; color: #FFF; }
        .result-main .val { font-size: 1.1rem; }
        .result-item .un { font-size: 0.4rem; color: rgba(255,255,255,0.5); }
        
        .toggle {
            background: none;
            border: none;
            color: rgba(255,255,255,0.4);
            font-size: 0.45rem;
            cursor: pointer;
            margin-top: 4px;
        }
        
        .details {
            display: none;
            margin-top: 4px;
            padding-top: 4px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.45rem;
        }
        .details.show { display: block; }
        .details div { display: flex; justify-content: space-between; padding: 1px 0; color: rgba(255,255,255,0.5); }
        .details span:last-child { color: rgba(255,255,255,0.8); }
        
        /* Footer */
        .footer {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--card);
            border-radius: 10px;
            padding: 6px 8px;
            margin-bottom: 6px;
        }
        
        .footer-logo {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            font-size: 0.4rem;
            color: var(--text3);
        }
        .footer-logo img { width: 100%; height: 100%; object-fit: contain; }
        .footer-info { flex: 1; }
        .footer-info input { height: 20px; font-size: 0.6rem; margin-bottom: 2px; }
        
        .branding {
            text-align: center;
            padding: 6px;
            font-size: 0.5rem;
        }
        .branding a { text-decoration: none; color: var(--text2); }
        .brand-solo { color: var(--text); font-weight: 600; }
        .brand-forte { color: var(--green); font-weight: 600; }
        
        /* FABs */
        .fabs {
            position: fixed;
            bottom: 12px;
            right: 8px;
            display: flex;
            gap: 6px;
        }
        .fab {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.12);
        }
        .fab-w { background: #FFF; }
        .fab-w svg { width: 14px; height: 14px; fill: var(--text2); }
        .fab-g { background: var(--green); }
        .fab-g svg { width: 14px; height: 14px; fill: #FFF; }
        
        /* PDF Mode */
        .pdf-ready {
            background: #FFF !important;
        }
        .pdf-ready .container {
            max-width: 100% !important;
            padding: 0 !important;
        }
        .pdf-ready .fabs,
        .pdf-ready .add-btn,
        .pdf-ready .photo-box .del {
            display: none !important;
        }
        .pdf-ready .details {
            display: block !important;
        }
        
        @media print {
            .fabs, .add-btn, .photo-box .del { display: none !important; }
            .details { display: block !important; }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>Estimativa de Produ√ß√£o ‚Äî Soja</h1>
    </header>
    
    <main class="container" id="content">
        <!-- Aviso -->
        <div class="aviso">
            <div class="aviso-title">üìå Expectativa de Produ√ß√£o (Estimativa T√©cnica)</div>
            <div class="aviso-text">üì¢ Os n√∫meros apresentados abaixo s√£o proje√ß√µes t√©cnicas e n√£o garantem resultados absolutos, estando sujeitos a varia√ß√µes devido a fatores clim√°ticos, de manejo e outros aspectos de campo.</div>
        </div>
        
        <!-- Identifica√ß√£o -->
        <section class="card">
            <div class="card-head">Identifica√ß√£o</div>
            <div class="card-body">
                <div class="row">
                    <div class="col"><label>Produtor</label><input type="text" id="produtor" placeholder="‚Äî"></div>
                </div>
                <div class="row">
                    <div class="col"><label>Fazenda</label><input type="text" id="fazenda" placeholder="‚Äî"></div>
                    <div class="col"><label>Cidade/UF</label><input type="text" id="cidade" placeholder="‚Äî"></div>
                </div>
                <div class="row">
                    <div class="col"><label>Cultivar</label><input type="text" id="cultivar" placeholder="‚Äî"></div>
                    <div class="col unit"><label>√Årea</label><input type="number" id="area" placeholder="‚Äî" step="0.1"><span>ha</span></div>
                    <div class="col"><label>Data</label><input type="date" id="data"></div>
                </div>
            </div>
        </section>
        
        <!-- Popula√ß√£o -->
        <section class="card">
            <div class="card-head">Popula√ß√£o</div>
            <div class="card-body">
                <div class="metric" id="metricLavoura">
                    <div class="photo-col empty" id="photoLavoura">
                        <button class="add-btn" onclick="addPhoto('lavoura')">+</button>
                    </div>
                    <div class="fields-col">
                        <div class="row">
                            <div class="col"><label>Plantas/Metro</label><input type="number" id="plantasMetro" placeholder="‚Äî" step="0.1"></div>
                            <div class="col unit"><label>Espa√ßamento</label><input type="number" id="espacamento" value="0.5" step="0.05"><span>m</span></div>
                        </div>
                        <div class="row">
                            <div class="col calc-field"><label>Plantas/ha</label><input type="text" id="plantasHa" readonly></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Componentes -->
        <section class="card">
            <div class="card-head">Componentes de Rendimento</div>
            <div class="card-body">
                <!-- Plantas -->
                <div class="metric" id="metricPlantas">
                    <div class="photo-col empty" id="photoPlantas">
                        <button class="add-btn" onclick="addPhoto('plantas')">+</button>
                    </div>
                    <div class="fields-col">
                        <div class="row">
                            <div class="col"><label>Plantas Aval.</label><input type="number" id="plantasAval" value="3" min="1"></div>
                            <div class="col"><label>Vagens/Pl</label><input type="number" id="vagens" placeholder="‚Äî" step="0.1"></div>
                        </div>
                        <div class="row">
                            <div class="col"><label>Gr√£os/Vagem</label><input type="number" id="graos" placeholder="‚Äî" step="0.1"></div>
                            <div class="col result-field"><label>Gr√£os/Pl</label><input type="text" id="rGraosPl" readonly></div>
                        </div>
                    </div>
                </div>
                
                <!-- PMG -->
                <div class="metric" id="metricPmg">
                    <div class="photo-col empty" id="photoPmg">
                        <button class="add-btn" onclick="addPhoto('pmg')">+</button>
                    </div>
                    <div class="fields-col">
                        <div class="row">
                            <div class="col unit"><label>PMG</label><input type="number" id="pmg" placeholder="‚Äî" step="0.1"><span>g</span></div>
                            <div class="col result-field"><label>g/Planta</label><input type="text" id="rGramasPl" readonly></div>
                        </div>
                    </div>
                </div>
                
                <!-- Entren√≥s -->
                <div class="metric" id="metricEntrenos">
                    <div class="photo-col empty" id="photoEntrenos">
                        <button class="add-btn" onclick="addPhoto('entrenos')">+</button>
                    </div>
                    <div class="fields-col">
                        <div class="row">
                            <div class="col"><label>Entren√≥s/Pl</label><input type="number" id="entrenos" placeholder="‚Äî"></div>
                            <div class="col unit"><label>Perdas</label><input type="number" id="perdas" value="20"><span>%</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Anota√ß√£o Geral -->
        <section class="card">
            <div class="card-head">Observa√ß√µes</div>
            <div class="card-body">
                <textarea id="anotacaoGeral" placeholder="Anota√ß√µes gerais, detalhes da avalia√ß√£o..."></textarea>
            </div>
        </section>
        
        <!-- Resultado -->
        <section class="result">
            <div class="result-grid">
                <div class="result-item"><small>kg/ha</small><div class="val" id="rKg">‚Äî</div></div>
                <div class="result-item"><small>Bruto</small><div class="val" id="rBruto">‚Äî</div><div class="un">sc/ha</div></div>
                <div class="result-item"><small>L√≠quido</small><div class="val" id="rLiqItem">‚Äî</div><div class="un">sc/ha</div></div>
                <div class="result-item result-main"><small>Produ√ß√£o Estimada</small><div class="val" id="rLiquido">‚Äî</div><div class="un">sacas/ha</div></div>
            </div>
            <button class="toggle" onclick="this.classList.toggle('open');document.getElementById('details').classList.toggle('show')">‚ñº Detalhes</button>
            <div class="details" id="details">
                <div><span>Vagens √ó Gr√£os</span><span id="d1">‚Äî</span></div>
                <div><span>√ó PMG/1000</span><span id="d2">‚Äî</span></div>
                <div><span>√ó Plantas/ha</span><span id="d3">‚Äî</span></div>
                <div><span>√∑ 1000 √∑ 60</span><span id="d4">‚Äî</span></div>
                <div><span>- Perdas</span><span id="d5">‚Äî</span></div>
            </div>
        </section>
        
        <!-- Footer -->
        <section class="footer">
            <div class="footer-logo" onclick="document.getElementById('logoInput').click()" id="logoBox">Logo</div>
            <div class="footer-info">
                <input type="text" id="editorNome" placeholder="Respons√°vel t√©cnico">
                <input type="text" id="editorContato" placeholder="Contato / CREA">
            </div>
        </section>
        
        <div class="branding">
            <a href="https://afonsoraudinei.github.io/Calculadorasoja/" target="_blank">
                <span class="brand-solo">Solo</span><span class="brand-forte">Forte</span>
                <span> ‚Äî Fazer novo c√°lculo</span>
            </a>
        </div>
    </main>
    
    <div class="fabs">
        <button class="fab fab-w" onclick="limpar()"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></button>
        <button class="fab fab-g" onclick="exportPDF()" title="Exportar PDF"><svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></button>
    </div>
    
    <input type="file" id="fileInput" accept="image/*" hidden>
    <input type="file" id="logoInput" accept="image/*" hidden>
    
    <script>
        let photos = JSON.parse(localStorage.getItem('soja_photos')) || {};
        let logo = localStorage.getItem('soja_logo') || null;
        let currentKey = null;
        
        const fields = ['produtor','fazenda','cidade','cultivar','area','data','plantasMetro','espacamento','plantasAval','vagens','graos','pmg','entrenos','perdas','editorNome','editorContato','anotacaoGeral'];
        const photoKeys = ['lavoura','plantas','pmg','entrenos'];
        
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderPhotos();
            renderLogo();
            calc();
            if (!document.getElementById('data').value) document.getElementById('data').valueAsDate = new Date();
        });
        
        function loadData() {
            const d = JSON.parse(localStorage.getItem('soja_data')) || {};
            fields.forEach(id => { 
                const el = document.getElementById(id); 
                if (el && d[id]) el.value = d[id]; 
            });
        }
        
        function saveData() {
            const d = {};
            fields.forEach(id => { 
                const el = document.getElementById(id); 
                if (el) d[id] = el.value; 
            });
            localStorage.setItem('soja_data', JSON.stringify(d));
        }
        
        function calcPlantasHa() {
            const pm = parseFloat(document.getElementById('plantasMetro').value) || 0;
            const esp = parseFloat(document.getElementById('espacamento').value) || 0.5;
            if (pm && esp) {
                const pl = Math.round(pm * (10000 / esp));
                document.getElementById('plantasHa').value = pl.toLocaleString('pt-BR');
                return pl;
            }
            document.getElementById('plantasHa').value = '';
            return 0;
        }
        
        function calc() {
            const plantasHa = calcPlantasHa();
            const v = parseFloat(document.getElementById('vagens').value) || 0;
            const g = parseFloat(document.getElementById('graos').value) || 0;
            const pmg = parseFloat(document.getElementById('pmg').value) || 0;
            const p = parseFloat(document.getElementById('perdas').value) || 0;
            
            const graosPl = v * g;
            document.getElementById('rGraosPl').value = graosPl ? graosPl.toFixed(1) : '';
            
            const gramasPl = graosPl * (pmg / 1000);
            document.getElementById('rGramasPl').value = gramasPl ? gramasPl.toFixed(2) : '';
            
            if (!plantasHa || !v || !g || !pmg) {
                ['rKg','rBruto','rLiqItem','rLiquido'].forEach(id => document.getElementById(id).textContent = '‚Äî');
                return;
            }
            
            const kgHa = (plantasHa * gramasPl) / 1000;
            const scB = kgHa / 60;
            const scL = scB * (1 - p / 100);
            
            document.getElementById('rKg').textContent = kgHa.toFixed(0);
            document.getElementById('rBruto').textContent = scB.toFixed(1);
            document.getElementById('rLiqItem').textContent = scL.toFixed(1);
            document.getElementById('rLiquido').textContent = scL.toFixed(2);
            
            document.getElementById('d1').textContent = `${v} √ó ${g} = ${graosPl.toFixed(1)}`;
            document.getElementById('d2').textContent = `${gramasPl.toFixed(2)} g/pl`;
            document.getElementById('d3').textContent = `${(plantasHa * gramasPl / 1000).toFixed(0)} kg`;
            document.getElementById('d4').textContent = `${scB.toFixed(2)} sc`;
            document.getElementById('d5').textContent = `${scL.toFixed(2)} sc (-${p}%)`;
            
            saveData();
        }
        
        fields.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', () => { calc(); saveData(); });
        });
        
        // Fotos
        function renderPhotos() {
            photoKeys.forEach(key => {
                const col = document.getElementById(`photo${key.charAt(0).toUpperCase() + key.slice(1)}`);
                if (!col) return;
                
                if (photos[key]?.src) {
                    col.classList.remove('empty');
                    col.innerHTML = `
                        <div class="photo-box">
                            <img src="${photos[key].src}">
                            <button class="del" onclick="delPhoto('${key}')">√ó</button>
                        </div>
                        <div class="photo-note">
                            <input placeholder="Anota√ß√£o" value="${photos[key].note||''}" oninput="saveNote('${key}',this.value)">
                        </div>
                    `;
                } else {
                    col.classList.add('empty');
                    col.innerHTML = `<button class="add-btn" onclick="addPhoto('${key}')">+</button>`;
                }
            });
        }
        
        function addPhoto(key) {
            currentKey = key;
            document.getElementById('fileInput').click();
        }
        
        document.getElementById('fileInput').addEventListener('change', async e => {
            const f = e.target.files[0];
            if (!f || !currentKey) return;
            photos[currentKey] = { src: await compress(f, 500, 0.6), note: '' };
            localStorage.setItem('soja_photos', JSON.stringify(photos));
            renderPhotos();
            e.target.value = '';
        });
        
        function saveNote(key, val) {
            if (photos[key]) {
                photos[key].note = val;
                localStorage.setItem('soja_photos', JSON.stringify(photos));
            }
        }
        
        function delPhoto(key) {
            delete photos[key];
            localStorage.setItem('soja_photos', JSON.stringify(photos));
            renderPhotos();
        }
        
        // Logo
        function renderLogo() {
            document.getElementById('logoBox').innerHTML = logo ? `<img src="${logo}">` : 'Logo';
        }
        
        document.getElementById('logoInput').addEventListener('change', async e => {
            const f = e.target.files[0];
            if (!f) return;
            logo = await compress(f, 80, 0.5);
            localStorage.setItem('soja_logo', logo);
            renderLogo();
            e.target.value = '';
        });
        
        function compress(file, max, q) {
            return new Promise(r => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.onload = () => {
                        const c = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > h && w > max) { h = h * max / w; w = max; }
                        else if (h > max) { w = w * max / h; h = max; }
                        c.width = w; c.height = h;
                        c.getContext('2d').drawImage(img, 0, 0, w, h);
                        r(c.toDataURL('image/jpeg', q));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        function limpar() {
            if (confirm('Limpar todos os dados?')) {
                localStorage.removeItem('soja_data');
                localStorage.removeItem('soja_photos');
                localStorage.removeItem('soja_logo');
                location.reload();
            }
        }
        
        function exportPDF() {
            // Preparar
            document.body.classList.add('pdf-ready');
            document.getElementById('details').classList.add('show');
            
            const content = document.getElementById('content');
            
            html2pdf().set({
                margin: 5,
                filename: 'estimativa-soja.pdf',
                image: { type: 'jpeg', quality: 0.9 },
                html2canvas: { 
                    scale: 1.5,
                    useCORS: true,
                    width: 380,
                    windowWidth: 380,
                    scrollY: 0,
                    scrollX: 0
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait'
                }
            }).from(content).toPdf().get('pdf').then(pdf => {
                // Link no rodap√©
                const w = pdf.internal.pageSize.getWidth();
                const h = pdf.internal.pageSize.getHeight();
                pdf.setFontSize(7);
                pdf.setTextColor(52, 199, 89);
                pdf.textWithLink('SoloForte - Fazer novo calculo', w/2, h - 3, {
                    url: 'https://afonsoraudinei.github.io/Calculadorasoja/',
                    align: 'center'
                });
            }).save().then(() => {
                document.body.classList.remove('pdf-ready');
                document.getElementById('details').classList.remove('show');
            });
        }
    </script>
</body>
</html>
